#### Сетевой игровой движок для игр в жанре `action`, `rpg`, `rts`, `tbs`, `tower defense` с видом сверху/изометрией.

Движок не является коробочным решением готовым к использованию и не является конкурентом нормальным движкам. :)

Движок является серверной частью игры решающую вопросы:

- [Конструктор и создание мира](#create-world)
- [Реализация игровых обьектов: "юниты", "строения", "пули"](#game-objects)
- [Бинарный протокол связи между серверов и клиентом](#binary-protocol)
- [Ввод пользователя](#input)
- [Движение обьектов в мире](#move)
- [Баллистика пуль/стрельба](#weapon)
- [Физическую модель обьектов](#physical-model)
- [Обнаружение коллизий, реакция на коллизию](#collision)
- [Реализация "Обзора"](#watch)
- [Создание и обновление игровых обьектов на стороне клиента](#create-update-client)
- [ИИ](#ai)
- [Поиск пути, управление движением ИИ](#ai-support)

Движок не решает вопросы графики и звука, это лежит на плечах клиента. В данном случае реализован клиент на игровом
движке [Phaser3](https://phaser.io/phaser3), в роли клиента может выступать все что умеет в вебсокеты. (или вообще любые
сокеты с небольшой переделкой api)

### Как работать с движком:

1) форкаете
2) работаете

### Немного об архитектуре:

Сервер состоит из 3х частей:

- `Роутер` - является посредником между клиентом и нодой.
- `Нода` - это сервис где происходит сама "игра", но 1 ноде может быть много игор.
- `Клиент` - та часть что видит игрок, является "терминалом" который просто выводит происходящие на экран с помощью
  графического движка.

Для работы сервера необходимо поднять 1 роутер и хотя бы 1 ноду. К одному роутеру может быть подключено много нод что
позволяет горизонтально масштабировать игру.

- Роутер и нода общаются между собой по rpc.
- Роутер и клиент общаются через websocket.
  ![This is an image](./readme_assets/img_2.png)

##### Как подключается нода:

1) когда нода запускается
   она [стучится по rpc](https://github.com/TrashPony/game-engine/blob/cc521dd593e2c302145b238165cb270b7a2d2dfe/node/rpc/rpc.go#L56)
   на `veliriURL` указаный в [main.ini](./main.ini)
2) дополнительным аргументом передает параметр `nodeUrl` указаный в [main.ini](./main.ini) (этот аргумент передает ip:
   port машины на которой запущена нода)
3) если соеденение успешно
   то [роутер ловит запрос](https://github.com/TrashPony/game-engine/blob/master/router/rpc/server.go#L65), и
   регистрирует ноду
   в [сторедже нод](https://github.com/TrashPony/game-engine/blob/master/router/mechanics/factories/nodes/nodes.go#L8),
   дает ему uuid и отсылает как ответ.
4) при добавление ноды в сторедж, сервер
   поднимает [обратный rpc канал](https://github.com/TrashPony/game-engine/blob/cc521dd593e2c302145b238165cb270b7a2d2dfe/router/mechanics/factories/nodes/nodes.go#L32)
   на ноду для полнодуплексной связи.
5) оба канала открыты, теперь на ноде будут запускатся новые сессии. В случае если на ноде происходит ошибка, или ошибка
   при передаче, или отвал по таймауту то нода удаляется из стореджа.

##### API ноды

Для каждой ноды на роутере есть свое апи выраженое как методы ноды. Посмотреть
можно [тут](https://github.com/TrashPony/game-engine/blob/cc521dd593e2c302145b238165cb270b7a2d2dfe/router/mechanics/game_objects/node/node.go#L74)
, нода ловит эти запросы [тут](https://github.com/TrashPony/game-engine/blob/master/node/rpc/rpc.go#L86).

- `CreateBattle` - создает новую сессию
- `FindBattle` - ищет бой по uuid
- `InitBattle` - когда бой создан, игрок запрашивает его состояние при загрузке на клиенте
- `StartLoad` - состояние было успешно получено и игрок запрашивает все обьекты в игре.
- `Input` - ввод игрока (клава/мышь)
- `CreateUnit` - создает юнита игроку инициатору
- `CreateBot` - создает бота в конкретную команду
- `CreateObj` - создает обьект (турель), в команду

##### Что посылает нода

Каждая нода [отправляет](https://github.com/TrashPony/game-engine/blob/master/node/rpc/rpc.go#L163) на роутер
данные обновление мира для каждого активного боя. Роутер
их [перенаправляет](https://github.com/TrashPony/game-engine/blob/master/router/rpc/server.go#L81) клиентам по
вебсокетам.

Маршрутизация сообщений для игроков на сокетах происходит
вот [тут](https://github.com/TrashPony/game-engine/blob/cc521dd593e2c302145b238165cb270b7a2d2dfe/router/web_socket/sender.go#L75)

### Как запустить:

##### короткий путь:

- короткого пути нет // TODO добавить доцкер

##### длинный путь:

- поднимаем сервер

```bash
go mod tidy;
go run ./router/main.go;
go run ./node/main.go;
```

- запускаем статику

```bash
cd .\static\;
npm run dev;
```

- заходим http://localhost:8083/

#### Игра ["Veliri"](https://yandex.ru/games/app/184316?lang=ru) (Session/MMO/Action) разработаная с помощью этого движка:

([ссылка на видео](https://www.youtube.com/watch?v=7D_ILFRQG2MQ))
[![Watch the video](/readme_assets/img_1.png)](https://www.youtube.com/watch?v=7D_ILFRQG2MQ)

<h3 id="create-world">
Конструктор и создание мира
</h3>

<h3 id="game-objects">
Реализация игровых обьектов: "юниты", "строения", "пули"
</h3>

<h3 id="binary-protocol">
Бинарный протокол связи между серверов и клиентом
</h3>

<h3 id="input">
Ввод пользователя
</h3>

<h3 id="move">
Движение обьектов в мире
</h3>

<h3 id="weapon">
Баллистика пуль/стрельба
</h3>

<h3 id="physical-model">
Физическую модель обьектов
</h3>

<h3 id="collision">
Обнаружение коллизий, реакция на коллизию
</h3>

<h3 id="watch">
Реализация "Обзора" игроков
</h3>

<h3 id="create-update-client">
Создание и обновление игровых обьектов на стороне клиента
</h3>

<h3 id="ai">
ИИ
</h3>

<h3 id="ai-support">
Поиск пути, управление движением ИИ
</h3>
